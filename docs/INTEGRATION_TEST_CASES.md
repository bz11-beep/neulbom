# 늘봄 통합 테스트 케이스

## 문서 정보

| 항목 | 내용 |
|------|------|
| 프로젝트명 | 늘봄 (AI 기반 노인 돌봄 음성 분석 시스템) |
| 문서 버전 | 1.0 |
| 작성일 | 2026-02-09 |
| 개발 기간 | 2025년 12월 ~ 2026년 2월 (2025.12.05 ~ 2026.02.10) |
| 개발 인원 | 5명 (최선임 총괄기획, 지태민 프론트엔드, 김승민 백엔드, 최대영 DB/IoT, 조민솔 기획/문서) |
| 문서 유형 | 통합 테스트 케이스 |

---

## 1. 사용자 관리

### 1.1 UR-001 보호자 회원가입

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | UR-001 |
| 요구사항명칭 | 보호자 회원가입 |
| 사전조건 | 서버(bomi.py)가 정상 기동되어 있고, MySQL(care_db)에 접속 가능한 상태. 회원가입 페이지(/signup)에 접근 가능해야 한다. |
| 세부내용 | ❍ 회원가입 페이지(signup.html)에 접속하여 보호자 정보(아이디, 비밀번호, 이름, 연락처, 우편번호, 주소, 상세주소)를 입력한다. |
| | ❍ 아이디 입력 후 "중복 확인" 버튼을 클릭하면 `/api/check-duplicate` API가 호출되어, 이미 존재하는 아이디의 경우 `isDuplicate: true`가 반환되고 "이미 사용 중인 아이디입니다" 메시지가 표시되는지 확인한다. |
| | ❍ 사용 가능한 아이디의 경우 `isDuplicate: false`가 반환되고 "사용 가능한 아이디입니다" 메시지가 표시되는지 확인한다. |
| | ❍ Daum Postcode API를 통해 우편번호 검색이 정상 동작하여, 우편번호와 기본주소가 자동 입력되는지 확인한다. |
| | ❍ 어르신 정보(이름, 성별, 생년월일, 연락처, 주소, 거주 형태, 보호자와의 관계)를 입력한다. |
| | ❍ 가입 버튼을 클릭하면 `/api/signup` API가 POST 방식으로 호출되어, tb_guardian 테이블에 보호자 정보가 INSERT되고 반환된 guardian_id를 FK로 하여 tb_senior 테이블에 어르신 정보가 INSERT되는지 확인한다. |
| | ❍ 생년월일이 YYYY-MM-DD 형식으로 조합되어 저장되는지 확인한다. |
| | ❍ 성별이 male/female에서 M/F로 변환되어 저장되는지 확인한다. |
| | ❍ 가입 성공 시 `{"message": "가입 성공", "guardian_id": N}` 응답이 반환되고 로그인 페이지로 이동하는지 확인한다. |
| | ❍ DB 에러 발생 시 rollback이 수행되고 500 에러 응답이 반환되는지 확인한다. |

### 1.2 UR-002 로그인

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | UR-002 |
| 요구사항명칭 | 로그인 |
| 사전조건 | UR-001에 의해 보호자 계정이 정상 생성되어 tb_guardian에 레코드가 존재해야 한다. 로그인 페이지(/login)에 접근 가능해야 한다. |
| 세부내용 | ❍ 로그인 페이지(login.html)에서 아이디와 비밀번호를 입력하고 로그인 버튼을 클릭한다. |
| | ❍ `/api/login` API가 POST 방식으로 호출되어, tb_guardian 테이블에서 user_id와 password가 일치하는 레코드가 조회되는지 확인한다. |
| | ❍ 로그인 성공 시 반환되는 JSON에 보호자 정보(username, name, phone, zipcode, address, addressDetail)가 포함되어 있는지 확인한다. |
| | ❍ 로그인 성공 시 tb_senior 테이블에서 guardian_id로 연결된 어르신 정보가 조회되어 응답에 포함되는지 확인한다. |
| | ❍ 어르신 정보에 생년월일이 birthYear, birthMonth, birthDay로 분리되어 반환되는지 확인한다. |
| | ❍ 어르신이 등록한 디바이스 목록이 tb_device에서 조회되어 devices 배열로 반환되는지 확인한다. 각 디바이스에 id, serial, name, location, status 필드가 포함되어야 한다. |
| | ❍ 존재하지 않는 아이디 또는 잘못된 비밀번호로 로그인 시도 시 401 에러(`{"error": "로그인 실패"}`)가 반환되는지 확인한다. |
| | ❍ 로그인 성공 후 대시보드(dashboard.html)로 정상 이동하는지 확인한다. |

### 1.3 UR-003 보호자 정보 수정

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | UR-003 |
| 요구사항명칭 | 보호자 정보 수정 |
| 사전조건 | UR-002에 의해 보호자가 로그인된 상태여야 한다. 마이페이지(mypage.html)에 접근 가능해야 한다. |
| 세부내용 | ❍ 마이페이지에서 보호자 정보 영역의 연락처, 우편번호, 주소, 상세주소 필드를 수정한다. |
| | ❍ 수정 버튼을 클릭하면 `/api/update-guardian` API가 POST 방식으로 호출되어, 요청 JSON에 username, phone, zipcode, address, addressDetail이 포함되어 전송되는지 확인한다. |
| | ❍ tb_guardian 테이블에서 해당 user_id의 phone, post_num, addr1, addr2 컬럼이 업데이트되는지 확인한다. |
| | ❍ 수정 성공 시 `{"message": "보호자 정보 수정 성공"}` 응답이 반환되는지 확인한다. |
| | ❍ 수정 실패 시 rollback이 수행되고 500 에러 응답이 반환되는지 확인한다. |

### 1.4 UR-004 어르신 정보 수정

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | UR-004 |
| 요구사항명칭 | 어르신 정보 수정 |
| 사전조건 | UR-002에 의해 보호자가 로그인된 상태이고, 보호자에 연결된 어르신 정보가 tb_senior에 존재해야 한다. |
| 세부내용 | ❍ 마이페이지에서 어르신 정보 영역의 연락처, 우편번호, 주소, 상세주소 필드를 수정한다. |
| | ❍ 수정 버튼을 클릭하면 `/api/update-senior` API가 POST 방식으로 호출되어, 요청 JSON에 username(보호자 아이디), phone, zipcode, address, addressDetail이 포함되어 전송되는지 확인한다. |
| | ❍ API 내부에서 username으로 tb_guardian에서 guardian_id를 조회하고, 해당 guardian_id로 tb_senior의 레코드를 UPDATE하는지 확인한다. |
| | ❍ 보호자 정보를 찾을 수 없는 경우 404 에러(`{"error": "보호자 정보를 찾을 수 없습니다."}`)가 반환되는지 확인한다. |
| | ❍ 수정 성공 시 `{"message": "어르신 정보 수정 성공"}` 응답이 반환되는지 확인한다. |

### 1.5 UR-005 비밀번호 변경

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | UR-005 |
| 요구사항명칭 | 비밀번호 변경 |
| 사전조건 | UR-002에 의해 보호자가 로그인된 상태여야 한다. |
| 세부내용 | ❍ 마이페이지의 비밀번호 변경 영역에서 현재 비밀번호, 새 비밀번호, 새 비밀번호 확인을 입력한다. |
| | ❍ 변경 버튼을 클릭하면 `/api/change-password` API가 POST 방식으로 호출되어, 요청 JSON에 username, currentPassword, newPassword가 포함되어 전송되는지 확인한다. |
| | ❍ tb_guardian에서 user_id와 현재 비밀번호가 일치하는지 먼저 검증하는지 확인한다. |
| | ❍ 현재 비밀번호가 일치하지 않는 경우 400 에러(`{"error": "현재 비밀번호가 일치하지 않습니다."}`)가 반환되는지 확인한다. |
| | ❍ 현재 비밀번호가 일치하면 tb_guardian의 password 컬럼이 새 비밀번호로 UPDATE되는지 확인한다. |
| | ❍ 변경 성공 시 `{"message": "비밀번호 변경 성공"}` 응답이 반환되는지 확인한다. |
| | ❍ 변경 후 새 비밀번호로 다시 로그인이 정상적으로 되는지 확인한다. |

---

## 2. 음성 분석

### 2.1 VA-001 음성 녹음 및 전송

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-001 |
| 요구사항명칭 | 음성 녹음 및 전송 |
| 사전조건 | 보호자가 로그인된 상태이고, 보미 대화 페이지(bomi.html)에 접근해야 한다. 브라우저에 마이크 권한이 허용되어 있어야 한다. HTTPS 연결이 활성화되어 있어야 한다. |
| 세부내용 | ❍ 보미 대화 페이지에서 녹음 버튼을 클릭하면 브라우저 MediaRecorder API가 활성화되어 마이크 입력이 시작되는지 확인한다. |
| | ❍ 녹음 중에는 녹음 상태 표시(녹음 아이콘 또는 애니메이션)가 활성화되는지 확인한다. |
| | ❍ 녹음 중지 버튼을 클릭하면 녹음이 종료되고, 오디오 데이터가 Blob 형태로 생성되는지 확인한다. |
| | ❍ 녹음된 음성 파일이 FormData에 `audio_file` 키로 추가되어 `/api/analyze` 엔드포인트로 POST 전송되는지 확인한다. |
| | ❍ FormData에 senior_id, sensing_id, generate_response 파라미터가 함께 전송되는지 확인한다. |
| | ❍ sensing_id가 없는 경우(센서 미등록) `/api/create-voice-session`을 먼저 호출하여 sensing_id를 발급받도록 유도하는지 확인한다. |
| | ❍ 서버에서 임시 파일이 NamedTemporaryFile로 정상 저장되고, 분석 후 삭제되는지 확인한다. |

### 2.2 VA-002 STT 변환

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-002 |
| 요구사항명칭 | STT 변환 |
| 사전조건 | VA-001에 의해 음성 파일이 서버에 전송된 상태. SpeechAnalyzer가 정상 초기화되어 Whisper 모델이 로드되어 있어야 한다. |
| 세부내용 | ❍ SpeechAnalyzer.analyze() 메서드가 호출되어 faster-whisper의 transcribe 함수가 실행되는지 확인한다. |
| | ❍ transcribe 호출 시 beam_size=1, language="ko", vad_filter=True 파라미터가 적용되는지 확인한다. |
| | ❍ 반환 결과에 text(변환 텍스트), word_count(단어 수), wpm(분당 어절 수), duration(발화 시간), response_time(반응 시간), avg_silence(평균 침묵), vpr(발화/침묵 비율) 필드가 모두 포함되는지 확인한다. |
| | ❍ 한국어 음성이 정상적으로 텍스트로 변환되는지 확인한다 (예: "안녕하세요"가 포함된 오디오 파일로 테스트). |
| | ❍ SSE 스트리밍으로 "STT 음성 인식 중..." (step 2) → "STT 완료" (step 3) 메시지가 순차적으로 클라이언트에 전달되는지 확인한다. |
| | ❍ 빈 오디오 파일 또는 침묵만 있는 파일에 대해 에러 없이 빈 텍스트가 반환되는지 확인한다. |

### 2.3 VA-003 감정 분석

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-003 |
| 요구사항명칭 | 감정 분석 |
| 사전조건 | VA-002에 의해 STT 텍스트가 추출된 상태. EmotionEnsemble이 정상 초기화되어 KcELECTRA 및 Wav2Vec2 모델이 로드되어 있어야 한다. |
| 세부내용 | ❍ EmotionEnsemble.predict(audio_path, text) 메서드가 호출되어 텍스트 감정 분석과 오디오 감정 분석이 동시에 수행되는지 확인한다. |
| | ❍ 오디오 파일이 16kHz로 리샘플링되고 최대 3초 구간만 로드되는지 확인한다. |
| | ❍ KcELECTRA 텍스트 감정 분석 결과에 text_label(감정 라벨)과 text_conf(신뢰도)가 포함되는지 확인한다. |
| | ❍ Wav2Vec2 오디오 감정 분석 결과에 audio_label(한글 매핑된 감정 라벨)과 audio_conf(신뢰도)가 포함되는지 확인한다. |
| | ❍ 오디오 감정 라벨이 영문(angry, happy, sad 등)에서 한글(분노, 기쁨, 슬픔 등)로 정상 매핑되는지 확인한다. |
| | ❍ YIN 알고리즘으로 피치(f0)가 추출되고 Z-peak 값이 계산되는지 확인한다. |
| | ❍ 최종 감정 결정 규칙이 정상 적용되는지 확인한다: 기본은 텍스트 감정, Z-peak > 2.5이고 오디오가 강한 감정이며 오디오 신뢰도 > 0.6일 때 오디오 감정으로 교체. |
| | ❍ 반환 결과에 final_emotion, text_label, audio_label, z_peak, audio_conf, text_conf 필드가 모두 포함되는지 확인한다. |
| | ❍ 분석 실패 시 기본값(중립, Z-peak=0)이 반환되어 시스템이 중단되지 않는지 확인한다. |

### 2.4 VA-004 음성 품질 점수

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-004 |
| 요구사항명칭 | 음성 품질 점수 |
| 사전조건 | VA-002의 STT 결과와 VA-003의 감정 분석 결과가 준비된 상태여야 한다. |
| 세부내용 | ❍ SpeechAnalyzer._calculate_scores() 메서드가 호출되어 8가지 차원의 점수가 산출되는지 확인한다. |
| | ❍ speed 점수: WPM이 100~150 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ duration 점수: 발화 시간이 3~10초 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ response 점수: 기본값 85.0이 설정되는지 확인한다. |
| | ❍ word_count 점수: 단어 수가 5~20개 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ vocabulary 점수: TTR이 0.6~0.9 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ silence 점수: 침묵 시간이 0~1초 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ emotion 점수: calculate_emotion_score 함수가 감정별로 적절한 점수를 반환하는지 확인한다 (긍정: 80~100, 중립: 70~80, 부정: 0~60). |
| | ❍ vitality 점수: VPR이 2.0~10.0 범위일 때 100점이 반환되는지 확인한다. |
| | ❍ 최적 범위 미만/초과 시 비례 감점이 정상 적용되는지 확인한다. |
| | ❍ 모든 점수가 0.0~100.0 범위 내에 있는지 확인한다 (max/min 클리핑). |
| | ❍ average(종합 점수)가 8개 차원 점수의 산술 평균으로 정확히 계산되는지 확인한다. |

### 2.5 VA-005 피치 분석

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-005 |
| 요구사항명칭 | 피치 분석 |
| 사전조건 | 유효한 오디오 파일이 16kHz로 로드된 상태여야 한다. |
| 세부내용 | ❍ EmotionEnsemble._calculate_pitch_zscore() 메서드가 호출되어 librosa.yin() 함수로 피치(f0)가 추출되는지 확인한다. |
| | ❍ yin 호출 시 fmin=65, fmax=500, frame_length=1024 파라미터가 적용되는지 확인한다. |
| | ❍ 유효한 피치 값(f0 > 0)만 필터링하여 Z-score 계산에 사용되는지 확인한다. |
| | ❍ 유효 피치 값이 5개 미만일 때 Z-peak=0.0이 반환되는지 확인한다. |
| | ❍ sigma_min(최소 표준편차) 값이 5.0으로 적용되어 분모가 0이 되는 것을 방지하는지 확인한다. |
| | ❍ Z-peak 값이 float 타입으로 반환되는지 확인한다. |
| | ❍ 예외 발생 시 0.0이 반환되어 시스템이 중단되지 않는지 확인한다. |

### 2.6 VA-006 실시간 분석 진행

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | VA-006 |
| 요구사항명칭 | 실시간 분석 진행 |
| 사전조건 | 보호자가 로그인된 상태이고, 브라우저에서 EventSource API가 지원되어야 한다. 음성 파일이 `/api/analyze`에 전송된 상태여야 한다. |
| 세부내용 | ❍ `/api/analyze` 응답의 Content-Type이 `text/event-stream`인지 확인한다. |
| | ❍ 응답 헤더에 `Cache-Control: no-cache`, `X-Accel-Buffering: no`, `Connection: keep-alive`가 설정되어 있는지 확인한다. |
| | ❍ SSE 스트림에서 step 1(파일 저장 완료) 이벤트가 가장 먼저 전송되는지 확인한다. |
| | ❍ step 2(STT 음성 인식 중) 이벤트가 분석 시작 시 전송되는지 확인한다. |
| | ❍ step 3(STT 완료) 이벤트에 text_preview(텍스트 미리보기 최대 50자)가 포함되는지 확인한다. |
| | ❍ step 4(감정 분석) 이벤트에 감정 라벨과 신뢰도 퍼센트가 포함되는지 확인한다. |
| | ❍ step 5(AI 응답 생성 중) 이벤트가 LLM 호출 시 전송되는지 확인한다. |
| | ❍ step 5.5(목소리 만드는 중) 이벤트가 TTS 생성 시 전송되는지 확인한다. |
| | ❍ step 5.7(TTS 완료) 이벤트에 tts_file(파일명)과 ai_response(AI 응답)가 포함되는지 확인한다. |
| | ❍ step 6(DB 저장 중) 이벤트가 DB 저장 시 전송되는지 확인한다. |
| | ❍ step complete(최종 결과) 이벤트에 success, voice_id, analysis(텍스트, 감정, 점수, whisper), ai_response, tts_file, metadata가 모두 포함되는지 확인한다. |
| | ❍ 분석 중 에러 발생 시 step error 이벤트가 전송되고 에러 메시지가 포함되는지 확인한다. |
| | ❍ 브라우저에서 EventSource로 수신한 각 단계별 메시지가 UI에 실시간으로 반영되는지 확인한다. |

---

## 3. AI 대화

### 3.1 AI-001 Q&A 데이터셋 매칭

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AI-001 |
| 요구사항명칭 | Q&A 데이터셋 매칭 |
| 사전조건 | LLMHandler가 use_qa_dataset=True로 초기화되어 있어야 한다. qa_dataset_improved.py의 ALL_QA_DATASET이 정상 로드되어 있어야 한다. |
| 세부내용 | ❍ LLMHandler.chat() 호출 시 Q&A 데이터셋 검색이 가장 먼저 수행되는지 확인한다. |
| | ❍ 1단계 매칭(정확한 일치): "넌 누구야?"를 입력하면 정확히 매칭되어 "할머니, 저 보미예요! 손녀 보미랍니다~"가 반환되는지 확인한다. |
| | ❍ 2단계 매칭(부분 일치): "약 복용 시간"을 입력하면 "약 복용 시간 알려줘"와 부분 일치하여 해당 답변이 반환되는지 확인한다. |
| | ❍ 3단계 매칭(키워드 일치): "오늘 산책 한번"을 입력하면 "산책" 키워드가 매칭되어 산책 관련 답변이 반환되는지 확인한다. |
| | ❍ Q&A 매칭 성공 시 last_qa_match에 matched=True, question, emotion, emotion_score가 저장되는지 확인한다. |
| | ❍ get_last_qa_match() 호출 시 마지막 매칭 정보가 정상 반환되는지 확인한다. |
| | ❍ Q&A 매칭 시 감정 라벨(emotion)과 감정 점수(emotion_score)가 서버 응답의 최종 감정값으로 덮어쓰여지는지 확인한다. |
| | ❍ 10개 카테고리(greeting, medicine, food, health, emotion, weather, family, activity, safety, time)에서 각각 1건 이상 정상 매칭되는지 확인한다. |
| | ❍ 매칭 실패 시(데이터셋에 없는 질문) None이 반환되고 2단계(LLM 호출)로 진행되는지 확인한다. |

### 3.2 AI-002 LLM 대화 생성

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AI-002 |
| 요구사항명칭 | LLM 대화 생성 |
| 사전조건 | OpenAI API 키가 api-key/openapi.env에 설정되어 있고, LLMHandler가 정상 초기화된 상태여야 한다. Q&A 데이터셋 매칭이 실패한 상태여야 한다. |
| 세부내용 | ❍ Q&A 매칭 실패 시 GPT-4o-mini 모델에 API 요청이 전송되는지 확인한다. |
| | ❍ 시스템 프롬프트에 기본 페르소나("당신은 20대 손녀 '보미'입니다")가 포함되는지 확인한다. |
| | ❍ emotion_info 파라미터가 전달되면 현재 감정 상태와 감정별 대화 전략이 시스템 프롬프트에 추가되는지 확인한다. |
| | ❍ 감정별 대화 전략이 적절한지 확인한다: 슬픔->위로/공감, 분노->경청/진정, 불안->안심/격려, 기쁨->맞장구, 중립->자연스러운 대화. |
| | ❍ scores 파라미터에서 average < 50 또는 emotion < 40일 때 고위험 프롬프트가 추가되는지 확인한다. |
| | ❍ scores 파라미터에서 average < 65 또는 emotion < 60일 때 중위험(관심 필요) 프롬프트가 추가되는지 확인한다. |
| | ❍ API 응답이 1-2문장의 짧고 다정한 한국어 텍스트로 반환되는지 확인한다. |
| | ❍ 대화 이력(history)이 올바르게 관리되는지 확인한다: system + user + assistant 메시지 순서. |
| | ❍ 대화 이력이 max_turns(10턴) 초과 시 오래된 메시지가 삭제되되 시스템 프롬프트는 유지되는지 확인한다. |
| | ❍ API 호출 실패 시 기본 응답("할머니, 제가 잠깐 딴생각을 했나 봐요. 다시 말씀해 주시겠어요?")이 반환되는지 확인한다. |
| | ❍ max_completion_tokens=1500이 설정되어 응답 길이가 제한되는지 확인한다. |

### 3.3 AI-003 TTS 음성 합성

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AI-003 |
| 요구사항명칭 | TTS 음성 합성 |
| 사전조건 | AI-001 또는 AI-002에 의해 AI 응답 텍스트가 생성된 상태. EdgeTTSHandler가 정상 초기화되어 있어야 한다. |
| 세부내용 | ❍ EdgeTTSHandler.speak() 메서드가 호출되어 AI 응답 텍스트가 음성으로 변환되는지 확인한다. |
| | ❍ 기본 음성(ko-KR-SunHiNeural)으로 생성되는지 확인한다. |
| | ❍ 생성된 파일이 MP3 형식으로 tts_outputs/ 디렉토리에 저장되는지 확인한다. |
| | ❍ 파일명이 `response_{timestamp}.mp3` 형식으로 생성되는지 확인한다. |
| | ❍ asyncio 비동기 방식으로 edge_tts.Communicate.save()가 호출되는지 확인한다. |
| | ❍ 브라우저에서 `/api/tts-audio/<filename>` 경로로 생성된 MP3 파일을 요청하면 정상 다운로드/재생되는지 확인한다. |
| | ❍ 빈 텍스트가 전달되면 TTS가 실행되지 않고 경고 메시지가 출력되는지 확인한다. |
| | ❍ TTS 생성 실패 시에도 AI 응답 텍스트는 정상적으로 클라이언트에 전달되는지 확인한다 (TTS 실패가 전체 프로세스를 중단시키지 않아야 함). |
| | ❍ 음성 목소리를 sun-hi, seo-hyeon, bong-jin 등으로 변경했을 때 해당 음성으로 생성되는지 확인한다. |

### 3.4 AI-004 대화 이력 관리

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AI-004 |
| 요구사항명칭 | 대화 이력 관리 |
| 사전조건 | LLMHandler가 정상 초기화된 상태여야 한다. |
| 세부내용 | ❍ LLMHandler 초기화 시 history 리스트가 빈 상태([])인지 확인한다. |
| | ❍ 첫 번째 대화 시 시스템 프롬프트가 history[0]에 추가되는지 확인한다. |
| | ❍ 사용자 메시지가 {"role": "user", "content": "..."} 형식으로 history에 추가되는지 확인한다. |
| | ❍ AI 응답이 {"role": "assistant", "content": "..."} 형식으로 history에 추가되는지 확인한다. |
| | ❍ 두 번째 이후 대화 시 시스템 프롬프트(history[0])가 최신 감정 상태로 업데이트되는지 확인한다. |
| | ❍ get_conversation_length() 호출 시 올바른 턴 수가 반환되는지 확인한다 (history 길이 기반 계산). |
| | ❍ max_turns(10) 초과 시 오래된 대화가 삭제되고 시스템 프롬프트 + 최근 대화만 유지되는지 확인한다. |
| | ❍ reset_conversation() 호출 시 history가 빈 상태로 초기화되고 last_qa_match도 None으로 초기화되는지 확인한다. |
| | ❍ Q&A 매칭 성공 시에는 history에 대화가 추가되지 않는지 확인한다 (Q&A는 LLM 호출 없이 바로 반환). |

---

## 4. 대시보드/리포트

### 4.1 DR-001 보호자 대시보드

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DR-001 |
| 요구사항명칭 | 보호자 대시보드 |
| 사전조건 | 보호자가 로그인된 상태이고, 대시보드(dashboard.html)에 접근해야 한다. 최소 1건 이상의 음성 분석 결과가 DB에 존재해야 한다. |
| 세부내용 | ❍ 대시보드 페이지에 접속하면 어르신의 감정 현황, 활동량, 인지 상태가 종합적으로 표시되는지 확인한다. |
| | ❍ 최근 감정 분석 결과(감정 라벨, 신뢰도)가 대시보드에 표시되는지 확인한다. |
| | ❍ Chart.js를 활용한 차트가 정상적으로 렌더링되는지 확인한다. |
| | ❍ 어르신 이름, 보호자 정보 등 기본 정보가 정확히 표시되는지 확인한다. |
| | ❍ 페이지 로드 시 API를 호출하여 최신 데이터를 가져오는지 확인한다. |
| | ❍ PC 브라우저와 모바일 브라우저 양쪽에서 반응형 레이아웃이 적용되는지 확인한다. |

### 4.2 DR-002 일간 활동 리포트

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DR-002 |
| 요구사항명칭 | 일간 활동 리포트 |
| 사전조건 | 보호자가 로그인된 상태이고, 해당 어르신에 모션 센서가 등록되어 있어야 한다. |
| 세부내용 | ❍ `/api/activity-daily` API가 POST 방식으로 호출되면, 요청 JSON에 username이 포함되어 전송되는지 확인한다. |
| | ❍ API 내부에서 보호자(tb_guardian) → 어르신(tb_senior) → 디바이스(tb_device) → 센서(tb_sensor, type='motion') 경로로 조인하여 모션 센서 ID를 찾는지 확인한다. |
| | ❍ 오늘 날짜(CURDATE())의 tb_sensing 데이터를 COUNT하여 활동 횟수를 반환하는지 확인한다. |
| | ❍ 센서가 없는 경우 count=0이 반환되는지 확인한다. |
| | ❍ 에러 발생 시에도 count=0을 반환하여 프론트엔드가 중단되지 않는지 확인한다. |
| | ❍ 반환된 활동 횟수가 대시보드/리포트 페이지에 정상 표시되는지 확인한다. |

### 4.3 DR-003 주간 활동 리포트

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DR-003 |
| 요구사항명칭 | 주간 활동 리포트 |
| 사전조건 | DR-002와 동일. 최근 7일간의 센서 데이터가 존재하면 더 의미 있는 테스트가 가능하다. |
| 세부내용 | ❍ `/api/activity-weekly` API가 POST 방식으로 호출되면, 최근 7일간의 일별 활동 횟수가 배열로 반환되는지 확인한다. |
| | ❍ 반환 배열의 길이가 정확히 7인지 확인한다 (data: [0,0,0,0,0,0,0] 형식). |
| | ❍ 배열의 인덱스 0이 6일 전, 인덱스 6이 오늘(최신)에 해당하는지 확인한다 (왼쪽=과거, 오른쪽=현재). |
| | ❍ 각 날짜별로 tb_sensing 테이블에서 DATE(created_at)와 비교하여 정확한 COUNT를 수행하는지 확인한다. |
| | ❍ 센서가 없는 경우 모든 요소가 0인 배열([0]*7)이 반환되는지 확인한다. |
| | ❍ 반환된 데이터가 Chart.js 주간 차트에 정상적으로 반영되는지 확인한다. |

### 4.4 DR-004 월간 활동 리포트

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DR-004 |
| 요구사항명칭 | 월간 활동 리포트 |
| 사전조건 | DR-002와 동일. 최근 4주간의 센서 데이터가 존재하면 더 의미 있는 테스트가 가능하다. |
| 세부내용 | ❍ `/api/activity-monthly` API가 POST 방식으로 호출되면, 최근 4주간의 주별 활동 횟수가 배열로 반환되는지 확인한다. |
| | ❍ 반환 배열의 길이가 정확히 4인지 확인한다 (data: [0,0,0,0] 형식). |
| | ❍ 배열의 인덱스 0이 3주 전(가장 오래된 주), 인덱스 3이 이번 주(최신)에 해당하는지 확인한다. |
| | ❍ 각 주차별로 시작일~종료일(7일 단위) 범위의 tb_sensing COUNT가 정확한지 확인한다. |
| | ❍ 역순 저장 로직(monthly_counts[3 - i])이 정상 동작하여 그래프 순서(왼쪽=과거, 오른쪽=현재)가 맞는지 확인한다. |
| | ❍ 반환된 데이터가 Chart.js 월간 차트에 정상적으로 반영되는지 확인한다. |

### 4.5 DR-005 감정 분석 차트

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DR-005 |
| 요구사항명칭 | 감정 분석 차트 |
| 사전조건 | 최소 1건 이상의 감정 분석 결과가 tb_analysis에 저장되어 있어야 한다. 대시보드 또는 리포트 페이지에 접근해야 한다. |
| 세부내용 | ❍ 감정 분석 결과(emotion_label, hap_ratio, sad_ratio, neu_ratio, ang_ratio, anxi_ratio, emba_ratio, heart_ratio)가 DB에서 정상 조회되는지 확인한다. |
| | ❍ Chart.js를 활용하여 감정별 비율이 차트(파이 차트 또는 바 차트)로 시각화되는지 확인한다. |
| | ❍ 최근 감정 변화 추이가 시계열 라인 차트로 표시되는지 확인한다. |
| | ❍ 감정 라벨이 한국어(기쁨, 슬픔, 중립, 분노, 불안, 당황)로 표시되는지 확인한다. |
| | ❍ 데이터가 없는 경우 빈 차트 또는 "데이터 없음" 메시지가 표시되어 에러가 발생하지 않는지 확인한다. |

---

## 5. 디바이스 관리

### 5.1 DV-001 디바이스 등록

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DV-001 |
| 요구사항명칭 | 디바이스 등록 |
| 사전조건 | 보호자가 로그인된 상태이고, 보호자에 연결된 어르신이 tb_senior에 존재해야 한다. |
| 세부내용 | ❍ 디바이스 등록 화면에서 시리얼 번호(serial), 기기 이름(name), 설치 위치(location)를 입력한다. |
| | ❍ 등록 버튼을 클릭하면 `/api/add-device` API가 POST 방식으로 호출되어, 요청 JSON에 serial, name, location, username이 포함되어 전송되는지 확인한다. |
| | ❍ API 내부에서 username → tb_guardian(guardian_id) → tb_senior(senior_id) 경로로 어르신 ID를 찾는지 확인한다. |
| | ❍ 보호자를 찾을 수 없는 경우 404 에러("사용자 정보를 찾을 수 없습니다.")가 반환되는지 확인한다. |
| | ❍ 어르신이 없는 경우 404 에러("등록된 어르신이 없습니다.")가 반환되는지 확인한다. |
| | ❍ tb_device에 device_uid, device_name, location, senior_id, installed_at이 정상 INSERT되는지 확인한다. |
| | ❍ 디바이스 등록 후 tb_sensor에 해당 device_id로 센서가 자동 등록되는지 확인한다. |
| | ❍ 기기 이름에 '환경'이 포함되면 sensor_type='env', 그 외에는 sensor_type='motion'으로 등록되는지 확인한다. |
| | ❍ 등록 성공 시 `{"message": "등록 성공", "device_id": N}` 응답이 반환되는지 확인한다. |
| | ❍ 등록 실패 시 rollback이 수행되고 500 에러 응답이 반환되는지 확인한다. |

### 5.2 DV-002 센서 상태 확인

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DV-002 |
| 요구사항명칭 | 센서 상태 확인 |
| 사전조건 | DV-001에 의해 디바이스와 센서가 등록된 상태이거나, 확인 대상 사용자의 계정이 존재해야 한다. |
| 세부내용 | ❍ `/api/check-sensor` API가 GET 또는 POST 방식으로 호출되면, username 파라미터가 수신되는지 확인한다. |
| | ❍ GET 방식: request.args.get('username')으로, POST 방식: request.get_json().get('username')으로 파라미터가 수신되는지 확인한다. |
| | ❍ username이 없는 경우 400 에러(has_sensor=false, "사용자 아이디가 필요합니다")가 반환되는지 확인한다. |
| | ❍ API 내부에서 보호자 → 어르신 → 디바이스 → 센서 4단계 JOIN 쿼리가 실행되는지 확인한다. |
| | ❍ 센서가 존재하면 has_sensor=true와 함께 sensor_id, sensor_type, device_id, device_name, location이 반환되는지 확인한다. |
| | ❍ 센서가 없으면 has_sensor=false와 "등록된 센서가 없습니다. 센서를 먼저 등록해주세요." 메시지가 반환되는지 확인한다. |
| | ❍ 가장 최근에 등록된 센서가 반환되는지 확인한다 (ORDER BY s.created_at DESC LIMIT 1). |

### 5.3 DV-003 음성 세션 생성

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | DV-003 |
| 요구사항명칭 | 음성 세션 생성 |
| 사전조건 | DV-001에 의해 디바이스와 센서가 등록된 상태여야 한다. 보호자가 로그인된 상태여야 한다. |
| 세부내용 | ❍ `/api/create-voice-session` API가 POST 방식으로 호출되면, 요청 JSON에 username이 포함되어 전송되는지 확인한다. |
| | ❍ username이 없는 경우 400 에러(success=false, "사용자 아이디가 필요합니다")가 반환되는지 확인한다. |
| | ❍ API 내부에서 보호자 → 어르신 → 디바이스 → 센서 경로로 센서를 찾는지 확인한다. |
| | ❍ 센서를 찾을 수 없는 경우 404 에러(success=false, "센서를 찾을 수 없습니다.")가 반환되는지 확인한다. |
| | ❍ 센서 발견 시 tb_sensing에 sensing_type='voice_session', sensing_value='recording_start'로 레코드가 INSERT되는지 확인한다. |
| | ❍ INSERT 후 cursor.lastrowid로 생성된 sensing_id가 반환되는지 확인한다. |
| | ❍ 성공 응답에 success=true, sensing_id, sensor_id, sensor_type, device_name, message가 포함되는지 확인한다. |
| | ❍ 반환된 sensing_id가 이후 `/api/analyze` 호출 시 파라미터로 사용 가능한지 확인한다. |
| | ❍ 실패 시 rollback이 수행되고 500 에러가 반환되는지 확인한다. |

---

## 6. 알림 시스템

### 6.1 AL-001 실시간 알림 확인

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AL-001 |
| 요구사항명칭 | 실시간 알림 확인 |
| 사전조건 | tb_alert 테이블에 received_yes=0(미읽음)인 알림 레코드가 1건 이상 존재해야 한다. |
| 세부내용 | ❍ `/api/check-alert` API가 GET 방식으로 호출되면, tb_alert에서 received_yes=0인 가장 최신 알림 1건이 조회되는지 확인한다. |
| | ❍ 조회 결과에 alert_id, alert_type, alert_content, sented_at 필드가 포함되는지 확인한다. |
| | ❍ sented_at이 datetime 객체일 경우 'YYYY-MM-DD HH:MM:SS' 문자열로 변환되어 반환되는지 확인한다. |
| | ❍ 미읽음 알림이 조회될 때 읽음 처리(UPDATE)가 수행되지 않는지 확인한다 (프론트엔드에서 ID 비교로 중복 표시 방지). |
| | ❍ 미읽음 알림이 없는 경우 null(None)이 반환되는지 확인한다. |
| | ❍ 프론트엔드에서 주기적(폴링 방식)으로 이 API를 호출하여 새로운 알림을 감지하고 팝업/알림 표시가 동작하는지 확인한다. |
| | ❍ `/api/alert-list` API가 POST 방식으로 호출되면, 최근 알림 10건(읽음/미읽음 모두)이 배열로 반환되는지 확인한다. |
| | ❍ alert-list 반환 배열이 sented_at DESC 순서(최신 우선)로 정렬되는지 확인한다. |
| | ❍ `/api/alert-read-all` API가 POST 방식으로 호출되면, tb_alert의 모든 레코드의 received_yes가 1로 UPDATE되는지 확인한다. |
| | ❍ alert-read-all 성공 시 `{"message": "모든 알림 읽음 처리 완료"}` 응답이 반환되는지 확인한다. |
| | ❍ 전체 읽음 처리 후 check-alert 호출 시 null이 반환되는지 확인한다. |

### 6.2 AL-002 위험 감지 알림

| 항목 | 내용 |
|------|------|
| 요구사항고유번호 | AL-002 |
| 요구사항명칭 | 위험 감지 알림 |
| 사전조건 | 음성 분석이 수행되어 점수가 산출된 상태여야 한다. LLMHandler의 위험 감지 로직이 활성화되어 있어야 한다. |
| 세부내용 | ❍ 음성 분석 결과의 종합 점수(average)가 50점 미만이거나 감정 점수(emotion)가 40점 미만일 때 고위험 상태로 판별되는지 확인한다. |
| | ❍ 고위험 상태 감지 시 LLM 시스템 프롬프트에 "주의: 고위험 상태 감지" 경고가 추가되어, AI 응답에 "괜찮으세요?", "어디 불편하신 데 없으세요?" 등의 안부 확인이 포함되는지 확인한다. |
| | ❍ 종합 점수(average)가 65점 미만이거나 감정 점수(emotion)가 60점 미만일 때 중위험(관심 필요) 상태로 판별되는지 확인한다. |
| | ❍ 중위험 상태 감지 시 LLM 프롬프트에 "주의: 관심 필요" 경고가 추가되는지 확인한다. |
| | ❍ 감정이 분노(확신도 높음)로 분석된 경우, 감정 점수가 낮게 산출되어(0~60) 위험 감지 조건에 부합하는지 확인한다. |
| | ❍ 감정이 기쁨 또는 중립(확신도 높음)으로 분석된 경우, 감정 점수가 70점 이상으로 산출되어 정상 범위로 판별되는지 확인한다. |
| | ❍ tb_alert 테이블에 위험 알림이 INSERT되면, 보호자 대시보드에서 해당 알림이 표시되는지 확인한다 (check-alert API 통해). |
| | ❍ 보호자용 리포트 생성(generate_report) 시 점수 데이터와 대화 요약이 GPT-4o-mini에 전달되어 보호자가 이해하기 쉬운 3-4문장의 리포트가 반환되는지 확인한다. |

---

## 문서 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-02-09 | - | 최초 작성 |
